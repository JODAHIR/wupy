
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta content="WUPY" name="description">
  <title>WUPY-JO</title>
  <meta name="author" content="JCODAHIR">
    <link href="favicon.ico" rel="icon">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
  <header class="bg-success text-white text-center py-3 mb-3 shadow-sm">
    <h3>ğŸ“Š Gastos WUPY's - <span id="mesActual"></span></h3>
  </header>
  <div class="container">
    <!-- Formulario de Gasto -->
    <form id="formGasto" class="card shadow-sm mb-4" onsubmit="agregarGasto(); return false;">
      <div class="card-body">
        <h5 class="card-title mb-3">ğŸ“‹ Agregar Gasto</h5>
        <div class="mb-3">
          <label class="form-label">ğŸ“‚ CategorÃ­a</label>
          <select id="categoria" class="form-select" required>
            <option value="combustible">â›½ï¸ Combustible</option>
            <option value="supermercado">ğŸ›’ Supermercado</option>
            <option value="comida">ğŸ½ï¸ Comida</option>
            <option value="fiesta">ğŸ‰ Fiesta</option>
            <option value="ocio">ğŸŸï¸ Entradas</option>
            <option value="otros">ğŸ’Š Farmacia</option>
            <option value="monchis">ğŸï¸ Monchis</option>
            <option value="biggie">ğŸ…±ï¸ Biggie</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">ğŸ“ Lugar</label>
          <input type="text" id="lugar" class="form-control" required>
        </div>
        <div class="mb-3 row">
          <div class="col-6">
            <label class="form-label">ğŸ’¸ Monto (Gs)</label>
            <input type="number" id="monto" class="form-control" required>
          </div>
          <div class="col-6">
            <label class="form-label">ğŸ”» Descuento (%)</label>
            <input type="number" id="descuento" class="form-control">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">ğŸ“… Fecha</label>
          <input type="date" id="fecha" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">ğŸ“ Nota</label>
          <textarea id="nota" class="form-control" rows="2"></textarea>
        </div>
        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-success">ğŸ’¾ Agregar Gasto</button>
          <button type="button" class="btn btn-outline-danger" onclick="resetearGastos()">ğŸ§¹ Resetear Mes</button>
        </div>
      </div>
    </form>

    <!-- Filtros -->
    <div class="row g-2 mb-3">
      <div class="col-12 col-sm-6">
        <input type="text" id="filtroTexto" class="form-control" placeholder="ğŸ” Buscar..." oninput="mostrarGastos()">
      </div>
      <div class="col-12 col-sm-6">
        <select id="filtroCategoria" class="form-select" onchange="mostrarGastos()">
          <option value="">ğŸ“‚ CategorÃ­as</option>
          <option value="combustible">â›½ï¸ Combustible</option>
          <option value="supermercado">ğŸ›’ Supermercado</option>
          <option value="comida">ğŸ½ï¸ Comida</option>
          <option value="fiesta">ğŸ‰ Fiesta</option>
          <option value="ocio">ğŸŸï¸ Entradas</option>
          <option value="otros">ğŸ’Š Farmacia</option>
          <option value="monchis">ğŸï¸ Monchis</option>
          <option value="biggie">ğŸ…±ï¸ Biggie</option>
        </select>
      </div>
    </div>

    <!-- ImportaciÃ³n / ExportaciÃ³n -->
    <div class="mb-4">
      <h5>â¬‡ï¸ Importar / Exportar</h5>
      <div class="d-flex flex-column flex-sm-row gap-2">
        <button class="btn btn-outline-primary w-100" onclick="exportarCSV()">ğŸ“¤ Exportar CSV</button>
        <input type="file" class="form-control w-100" id="inputCSV" accept=".csv">
      </div>
    </div>
    <hr>
    <!-- Resumen por categorÃ­a -->
    <div class="row" id="resumen"></div>

    <!-- Tabla de gastos -->
    <div class="table-responsive mt-4">
      <table class="table table-bordered table-hover" id="tablaGastos"></table>
    </div>

    <!-- GrÃ¡fico -->
    <div class="chart my-4 text-center">
      <canvas id="graficoGastos" height="300"></canvas>
    </div>
  </div>

  <script>
    const gastos = JSON.parse(localStorage.getItem('gastos')) || [];
    const presupuestos = JSON.parse(localStorage.getItem('presupuestos')) || {
      combustible: 1000000,
      supermercado: 1000000,
      comida: 1000000,
      fiesta: 1000000,
      ocio: 1000000,
      otros: 1000000,
      monchis: 500000,
      biggie: 1000000
    };

    document.getElementById('fecha').valueAsDate = new Date();
    document.getElementById('mesActual').innerText = new Date().toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

    function agregarGasto() {
      const categoria = document.getElementById('categoria').value;
      const lugar = document.getElementById('lugar').value.trim();
      const monto = parseFloat(document.getElementById('monto').value);
      const descuento = parseFloat(document.getElementById('descuento').value) || 0;
      const fecha = document.getElementById('fecha').value;
      const nota = document.getElementById('nota').value;
      const final = monto * (1 - descuento / 100);

      if (!monto || monto <= 0 || !fecha || !categoria || !lugar) return;

      gastos.push({ categoria, lugar, monto, descuento, fecha, nota, final });
      localStorage.setItem('gastos', JSON.stringify(gastos));
      mostrarGastos();
    }

    
    function formatoGs(n) {
      return parseFloat(n).toLocaleString('es-PY', { style: 'currency', currency: 'PYG', minimumFractionDigits: 0 });
    }


    function mostrarGastos() {
      const texto = document.getElementById('filtroTexto').value.toLowerCase();
      const filtro = document.getElementById('filtroCategoria').value;

      const filtrados = gastos.filter(g => 
        (!filtro || g.categoria === filtro) &&
        (g.lugar.toLowerCase().includes(texto) || (g.nota || '').toLowerCase().includes(texto))
      );

      const tabla = document.getElementById('tablaGastos');
      if (!filtrados.length) {
        tabla.innerHTML = '<tr><td colspan="8" class="text-center">Sin datos</td></tr>';
        actualizarResumen(filtrados);
        return;
      }

      tabla.innerHTML = `
        <thead><tr>
          <th>Fecha</th><th>CategorÃ­a</th><th>Lugar</th><th>Monto</th><th>Des (%)</th><th>Reintegro (Gs)</th><th>A pagar</th><th>Nota</th>
        </tr></thead><tbody>
        ${filtrados.map(g => `
          <tr>
            <td>${g.fecha}</td>
            <td>${g.categoria}</td>
            <td>${g.lugar}</td>
            <td>${formatoGs(g.monto)}</td>
            <td>${g.descuento}%</td>
            <td>${formatoGs(g.monto * g.descuento / 100)}</td>
            <td>${formatoGs(g.final)}</td>
            <td>${g.nota || ""}</td>
          </tr>`).join('')}
        </tbody>`;

      actualizarResumen(filtrados);
    }

    function actualizarResumen(lista = gastos) {
      const resumen = document.getElementById("resumen");
      const totales = {};
      lista.forEach(g => {
        if (!totales[g.categoria]) totales[g.categoria] = 0;
        totales[g.categoria] += g.final;
      });
      Object.keys(totales).forEach(cat => {
        if (!presupuestos[cat]) presupuestos[cat] = 1000000;
      });

      const colores = {
        combustible: "#f44336", supermercado: "#2196F3", comida: "#FFC107", fiesta: "#9C27B0",
        ocio: "#FF9800", otros: "#607D8B", monchis: "#800080", biggie: "#800000"
      };
      const iconos = {
        combustible: "â›½", supermercado: "ğŸ›’", comida: "ğŸ½ï¸", fiesta: "ğŸ‰",
        ocio: "ğŸŸï¸", otros: "ğŸ’Š", monchis: "ğŸï¸", biggie: "ğŸ…±ï¸"
      };

      resumen.innerHTML = Object.keys(totales).map(cat => {
        const usado = totales[cat];
        const asignado = presupuestos[cat];
        const restante = asignado - (usado + descuento);
        return `
          <div class="col-12 col-md-6 col-lg-4 mb-3">
            <div class="border rounded p-3" style="background-color: ${colores[cat] || '#999'}10; border-color: ${colores[cat] || '#999'}">
              <h6 style="color: ${colores[cat] || '#999'}">${iconos[cat] || "ğŸ“¦"} ${cat}</h6>
              <div>Asignado: <b>${formatoGs(asignado)}</b></div>
              <div>Usado: <b>${formatoGs(usado)}</b></div>
              <div>Restante: <b style="color: ${restante < 0 ? 'red' : 'green'}">${formatoGs(restante)}</b></div>
            </div>
          </div>`;
      }).join("");

      graficar(totales);
    }

    function graficar(totales) {
      const ctx = document.getElementById('graficoGastos').getContext('2d');
      const categorias = Object.keys(totales);
      const datos = Object.values(totales);
      const colores = categorias.map(cat => ({
        combustible: "#f44336", supermercado: "#2196F3", comida: "#FFC107", fiesta: "#9C27B0",
        ocio: "#FF9800", otros: "#607D8B", monchis: "#800080", biggie: "#800000"
      }[cat] || "#999"));

      if (window.chart) window.chart.destroy();
      window.chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: categorias,
          datasets: [{
            data: datos,
            backgroundColor: colores
          }]
        },
        options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function exportarCSV() {
      const rows = [["Lugar","CategorÃ­a","Fecha","Monto","Descuento","Total"], ...gastos.map(g => [g.lugar, g.categoria, g.fecha, g.monto, g.descuento, g.final])];
      const csv = rows.map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "gastos.csv";
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById("inputCSV").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        const lines = event.target.result.split("\n").slice(1);
        lines.forEach(line => {
          const [lugar, categoria, fecha, monto, descuento, total] = line.split(",");
          if (lugar && categoria && fecha) {
            gastos.push({ lugar, categoria, fecha, monto: parseFloat(monto), descuento: parseFloat(descuento), final: parseFloat(total), nota: "Importado" });
          }
        });
        localStorage.setItem("gastos", JSON.stringify(gastos));
        mostrarGastos();
      };
      reader.readAsText(file);
    });

    function resetearGastos() {
      if (confirm("Â¿Eliminar todos los gastos?")) {
        localStorage.removeItem("gastos");
        location.reload();
      }
    }

    mostrarGastos();
  </script>
</body>
</html>
